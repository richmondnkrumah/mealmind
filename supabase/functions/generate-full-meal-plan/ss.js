const json_data = {
  "event_message": "###MONDAY###\n@@BREAKFAST@@\nrecipeName:: Scrambled Eggs with Kale and Chard\ncookTime:: 10 min\ncalories:: 320 kcal\nimagePrompt:: Fluffy scrambled eggs with vibrant green kale and chard on a white plate\ningredients:: 2 large eggs~~1/4 cup unsweetened almond milk~~1 cup chopped kale~~1 cup chopped chard~~1 tbsp olive oil~~Salt to taste~~Black pepper to taste\ninstructions:: Heat olive oil in a non-stick pan over medium heat.~~Add chopped kale and chard, sauté for 3-5 minutes until wilted.~~Whisk eggs with almond milk, salt, and pepper.~~Pour egg mixture into the pan with the greens.~~Scramble until cooked to desired consistency.~~Serve immediately.\n@@LUNCH@@\nrecipeName:: Chicken Salad Lettuce Wraps\ncookTime:: 15 min\ncalories:: 450 kcal\nimagePrompt:: Fresh lettuce cups filled with creamy chicken salad, garnished with a sprinkle of paprika\ningredients:: 1.5 cups cooked chicken breast, shredded~~1/4 cup mayonnaise (low-carb)~~2 tbsp chopped celery~~1 tbsp chopped red onion~~1 tsp Dijon mustard~~Salt to taste~~Black pepper to taste~~4 large romaine lettuce leaves\ninstructions:: In a medium bowl, combine shredded chicken, mayonnaise, celery, red onion, Dijon mustard, salt, and pepper.~~Mix well until all ingredients are evenly coated.~~Spoon the chicken salad into the romaine lettuce leaves.~~Serve immediately as wraps.\n@@DINNER@@\nrecipeName:: Baked Salmon with Roasted Asparagus and Broccoli\ncookTime:: 25 min\ncalories:: 600 kcal\nimagePrompt:: A perfectly baked salmon fillet with tender roasted asparagus and bright green broccoli florets\ningredients:: 6 oz salmon fillet~~1 bunch asparagus, trimmed~~1.5 cups broccoli florets~~1 tbsp olive oil~~1/2 lemon, sliced~~1 clove garlic, minced~~Salt to taste~~Black pepper to taste\ninstructions:: Preheat oven to 400°F (200°C).~~Place salmon fillet on a baking sheet lined with parchment paper.~~Toss asparagus and broccoli with olive oil, minced garlic, salt, and pepper on the same baking sheet.~~Arrange lemon slices over the salmon.~~Bake for 15-20 minutes, or until salmon is cooked through and vegetables are tender-crisp.~~Serve hot.\n###TUESDAY###\n@@BREAKFAST@@\nrecipeName:: Cottage Cheese with Cucumber and Radish\ncookTime:: 5 min\ncalories:: 300 kcal\nimagePrompt:: A bowl of creamy cottage cheese topped with fresh slices of cucumber and vibrant red radishes\ningredients:: 1 cup full-fat cottage cheese~~1/2 cucumber, sliced~~4-5 radishes, thinly sliced~~Pinch of black pepper\ninstructions:: Place cottage cheese in a bowl.~~Arrange cucumber and radish slices on top of the cottage cheese.~~Sprinkle with black pepper.~~Serve immediately.\n@@LUNCH@@\nrecipeName:: Tuna and Celery Salad\ncookTime:: 10 min\ncalories:: 420 kcal\nimagePrompt:: A fresh tuna salad with crisp celery, served in a bowl with a side of green lettuce leaves\ningredients:: 1 can (5 oz) tuna in water, drained~~2 tbsp mayonnaise (low-carb)~~1/4 cup chopped celery~~1 tbsp chopped red onion~~1/2 tsp Dijon mustard~~Salt to taste~~Black pepper to taste~~2 cups mixed greens\ninstructions:: In a medium bowl, flake the drained tuna.~~Add mayonnaise, chopped celery, red onion, Dijon mustard, salt, and pepper.~~Mix well until combined.~~Serve the tuna salad over a bed of mixed greens.\n@@DINNER@@\nrecipeName:: Ground Beef and Cabbage Stir-fry\ncookTime:: 25 min\ncalories:: 650 kcal\nimagePrompt:: Savory ground beef stir-fried with shredded cabbage and thinly sliced onions, served in a rustic bowl\ningredients:: 1 lb ground beef (85/15)~~1 tbsp olive oil~~1 large onion, thinly sliced~~4 cups shredded cabbage~~2 cloves garlic, minced~~1 tbsp ginger, grated (optional)~~2 tbsp tamari or low-sodium soy sauce~~1 tsp sesame oil~~Salt to taste~~Black pepper to taste\ninstructions:: Heat olive oil in a large skillet or wok over medium-high heat.~~Add ground beef and cook, breaking it up with a spoon, until browned.~~Drain any excess fat.~~Add sliced onion to the skillet and sauté for 3-4 minutes until softened.~~Stir in minced garlic and grated ginger (if using), cook for 1 minute until fragrant.~~Add shredded cabbage and cook for 5-7 minutes, stirring occasionally, until tender-crisp.~~Pour in tamari/soy sauce and sesame oil, mix well.~~Season with salt and pepper.~~Serve hot.\n###WEDNESDAY###\n@@BREAKFAST@@\nrecipeName:: High-Protein Green Smoothie\ncookTime:: 5 min\ncalories:: 350 kcal\nimagePrompt:: A vibrant green smoothie in a tall glass, garnished with a few spinach leaves\ningredients:: 1 scoop vanilla or unflavored protein powder~~1 cup unsweetened almond milk~~1 cup fresh spinach~~1/2 cup kale~~1 tbsp chia seeds~~5-6 ice cubes\ninstructions:: Combine protein powder, almond milk, spinach, kale, and chia seeds in a blender.~~Add ice cubes.~~Blend until smooth and creamy.~~Pour into a glass and serve immediately.\n@@LUNCH@@\nrecipeName:: Grilled Chicken and Garden Salad\ncookTime:: 20 min\ncalories:: 500 kcal\nimagePrompt:: A vibrant salad bowl with grilled chicken strips, mixed greens, cherry tomatoes, cucumber, and a light vinaigrette\ningredients:: 6 oz chicken breast~~2 tbsp olive oil~~1 tbsp lemon juice~~Salt to taste~~Black pepper to taste~~4 cups mixed greens (lettuce, romaine, kale, chard)~~1/2 cucumber, sliced~~1/2 cup cherry tomatoes, halved~~1/4 carrot, grated (optional, for flavor)~~2 tbsp vinaigrette (low-carb)\ninstructions:: Pound chicken breast to an even thickness if needed.~~Season chicken with 1 tbsp olive oil, lemon juice, salt, and pepper.~~Heat a grill pan or skillet over medium-high heat.~~Grill chicken for 6-8 minutes per side, or until cooked through.~~Let rest, then slice.~~In a large bowl, combine mixed greens, cucumber, cherry tomatoes, and grated carrot (if using).~~Drizzle with vinaigrette and toss.~~Top the salad with sliced grilled chicken.~~Serve.\n@@DINNER@@\nrecipeName:: Pan-Seared Pork Chops with Steamed Kale and Side Salad\ncookTime:: 25 min\ncalories:: 620 kcal\nimagePrompt:: Two golden-brown pan-seared pork chops next to a pile of steamed kale and a fresh side salad\ningredients:: 2 boneless pork chops (about 5-6 oz each)~~1 tbsp olive oil~~1 clove garlic, minced~~2 cups kale, stemmed and chopped~~1/2 lemon~~Salt to taste~~Black pepper to taste~~2 cups mixed greens (lettuce, romaine)~~1/4 cucumber, sliced~~2 tbsp vinaigrette (low-carb)\ninstructions:: Pat pork chops dry and season generously with salt and pepper.~~Heat olive oil in a large skillet over medium-high heat.~~Sear pork chops for 4-6 minutes per side, until golden brown and cooked through (internal temp 145°F/63°C).~~Remove pork chops from skillet and set aside to rest.~~Add minced garlic to the same skillet, cook for 30 seconds.~~Add chopped kale and a splash of water, cover, and steam for 3-5 minutes until tender.~~Squeeze lemon juice over the kale.~~In a separate bowl, toss mixed greens and cucumber with vinaigrette for the side salad.~~Serve pork chops with steamed kale and the side salad.\n###THURSDAY###\n@@BREAKFAST@@\nrecipeName:: Spinach and Onion Omelet\ncookTime:: 15 min\ncalories:: 380 kcal\nimagePrompt:: A fluffy, golden omelet generously filled with wilted spinach and sautéed onions\ningredients:: 3 large eggs~~2 tbsp unsweetened almond milk~~1 cup fresh spinach~~1/4 small onion, finely diced~~1 tbsp olive oil~~Salt to taste~~Black pepper to taste\ninstructions:: Whisk eggs with almond milk, salt, and pepper in a bowl.~~Heat olive oil in a non-stick skillet over medium heat.~~Add diced onion and sauté for 3 minutes until softened.~~Add spinach and cook until wilted, about 2-3 minutes.~~Pour egg mixture over the spinach and onion.~~Cook undisturbed for 2-3 minutes until edges set.~~Gently fold one side over the other and cook for another 1-2 minutes until cooked through.~~Serve immediately.\n@@LUNCH@@\nrecipeName:: Turkey and Cheese Roll-Ups with Celery and Cucumber Sticks\ncookTime:: 10 min\ncalories:: 400 kcal\nimagePrompt:: Colorful turkey and cheese roll-ups neatly arranged with crisp celery and cucumber sticks on a light blue plate\ningredients:: 6 slices deli turkey breast (low sodium)~~6 slices provolone or cheddar cheese~~1/4 cup cream cheese (optional, for spreading)~~2 celery stalks, cut into sticks~~1/2 cucumber, cut into sticks\ninstructions:: Lay out each slice of turkey.~~If using, spread a thin layer of cream cheese on each turkey slice.~~Place a slice of cheese on top of the turkey.~~Roll up tightly.~~Serve with celery sticks and cucumber sticks on the side.\n@@DINNER@@\nrecipeName:: Pan-Seared Shrimp with Steamed Broccoli and Romaine Salad\ncookTime:: 20 min\ncalories:: 580 kcal\nimagePrompt:: Juicy pan-seared shrimp alongside bright green steamed broccoli and a crisp romaine lettuce salad\ningredients:: 1 lb large shrimp, peeled and deveined~~1 tbsp olive oil~~2 cloves garlic, minced~~1/2 tsp red pepper flakes (optional)~~Juice of 1/2 lemon~~1.5 cups broccoli florets~~3 cups romaine lettuce, chopped~~1/4 cup cucumber, diced~~2 tbsp vinaigrette (low-carb)~~Salt to taste~~Black pepper to taste\ninstructions:: Steam broccoli florets for 5-7 minutes until tender-crisp.~~Season shrimp with salt and pepper.~~Heat olive oil in a large skillet over medium-high heat.~~Add shrimp, minced garlic, and red pepper flakes (if using) to the skillet.~~Cook for 2-3 minutes per side, until pink and cooked through.~~Squeeze lemon juice over the cooked shrimp.~~In a bowl, combine chopped romaine and diced cucumber.~~Dress the salad with vinaigrette.~~Serve pan-seared shrimp with steamed broccoli and the romaine salad.\n###FRIDAY###\n@@BREAKFAST@@\nrecipeName:: Berry & Protein Chia Pudding\ncookTime:: 5 min\ncalories:: 370 kcal\nimagePrompt:: A glass jar filled with creamy chia pudding, topped with a few fresh berries and a sprinkle of nuts\ningredients:: 1/4 cup chia seeds~~1 cup unsweetened almond milk~~1 scoop vanilla or unflavored protein powder~~1/2 tsp vanilla extract~~1/4 cup mixed berries (small amount for low carb)~~2 tbsp chopped walnuts or almonds (optional)\ninstructions:: In a jar or container, whisk together chia seeds, almond milk, protein powder, and vanilla  ....[truncated]",
  "id": "48142ed6-d95a-45d7-a243-8670abcfbe00",
  "metadata": [
    {
      "boot_time": null,
      "cpu_time_used": null,
      "deployment_id": "hgdrimuveerytorfmhoy_0605b777-2450-4309-ad5c-ed7aff502721_17",
      "event_type": "Log",
      "execution_id": "69ac8be2-63c3-4757-8933-e70bb9beb0d2",
      "function_id": "0605b777-2450-4309-ad5c-ed7aff502721",
      "level": "info",
      "memory_used": [],
      "project_ref": "hgdrimuveerytorfmhoy",
      "reason": null,
      "region": "eu-west-3",
      "served_by": "supabase-edge-runtime-1.69.4 (compatible with Deno v2.1.4)",
      "timestamp": "2025-11-05T02:16:31.466Z",
      "version": "17"
    }
  ],
  "timestamp": 1762308991466000
}
const per = json_data.event_message

function parseAIResponse(text) {
  const plan = { weekly_plan: {}, shopping_list: [] };
  // A more robust regex to find day blocks, handling potential whitespace
  const dayRegex = /###\s*(\w+)\s*###([\s\S]*?)(?=###|$)/g;
  let dayMatch;

  while ((dayMatch = dayRegex.exec(text)) !== null) {
    const dayName = dayMatch[1].toLowerCase();
    const dayContent = dayMatch[2];
    
    const dayPlan = {};
    // A more robust regex to find meal blocks
    const mealRegex = /@@\s*(\w+)\s*@@([\s\S]*?)(?=@@|###|$)/g;
    let mealMatch;

    while ((mealMatch = mealRegex.exec(dayContent)) !== null) {
      const mealName = mealMatch[1].toLowerCase();
      const mealContent = mealMatch[2].trim();
      const recipe = {};

      // --- THE FIX IS HERE: A simpler, more reliable parsing method ---
      // 1. Split the entire block by the '::' delimiter.
      // This gives us an array like: ['recipeName', 'Scrambled Eggs ingredients', 'Egg~~Toast instructions', '...']
      const parts = mealContent.split('::');

      // 2. Iterate through the parts to reconstruct key-value pairs.
      for (let i = 0; i < parts.length - 1; i++) {
        const valueAndNextKey = parts[i + 1];
        
        // Find the last word of the current part, which is the key.
        const keyMatch = parts[i].match(/(\w+)$/);
        if (!keyMatch) continue;
        const key = keyMatch[0];

        // The value is everything in the next part until the start of the next key.
        const nextKeyMatch = valueAndNextKey.match(/\s(\w+)$/);
        const value = nextKeyMatch ? valueAndNextKey.substring(0, nextKeyMatch.index).trim() : valueAndNextKey.trim();

        // 3. Assign the cleaned key and value to the recipe object.
        if (key && value) {
          if (key === "ingredients" || key === "instructions") {
            recipe[key] = value.split("~~").map(item => item.trim()).filter(Boolean);
          } else {
            recipe[key] = value;
          }
        }
      }
      dayPlan[mealName] = recipe;
    }
    plan.weekly_plan[dayName] = dayPlan;
  }

  // Shopping list logic can be added here later
  return plan;
}
const res = parseAIResponse(per)
console.log(res.weekly_plan)